<?phpif (!defined('SOURCES')) die("Error");/** * @var $config *//* Query allpage */$favicon = $cache->get("select photo from #_photo where type = ? and act = ? and find_in_set('hienthi',status) limit 0,1", array('favicon', 'photo_static'), 'fetch', 7200);$logo = $cache->get("select id, photo, options from #_photo where type = ? and act = ? limit 0,1", array('logo', 'photo_static'), 'fetch', 7200);$logoFooter = $cache->get("select id, photo, options from #_photo where type = ? and act = ? limit 0,1", array('banner-footer', 'photo_static'), 'fetch', 7200);$banner = $cache->get("select photo from #_photo where type = ? and act = ? limit 0,1", array('banner', 'photo_static'), 'fetch', 7200);$staticContents = $iCache->remember('index_static_contents', 3600, function () use ($lang, $d) {    $staticContents = new \Illuminate\Support\Collection($d->rawQuery("select name$lang, content$lang, type, id from #_static where type IN('slogan','footer', 'gioi-thieu', 'lien-he') and find_in_set('hienthi',status)"));    $grouped = $staticContents->mapToGroups(function (array $item, int $key) {        return [$item['type'] => $item];    });    $grouped->all();    return $grouped;});$social = $cache->get("select name$lang, photo, link from #_photo where type = ? and find_in_set('hienthi',status) order by numb,id desc", array('social'), 'result', 7200);$splist = $iCache->remember('index_splist', 3600, function () use ($lang, $d) {    return $d->rawQuery("select name$lang, slugvi, slugen, id from #_product_list where type = ? and find_in_set('hienthi',status) order by numb,id desc", array('san-pham'), 'result', 7200);});$indexMenu = $iCache->remember('index_header_menu', 3600, function () use ($splist, $lang, $d) {    $_menu = [];    foreach ($splist as $klist => $vlist) {        $_menu[$klist]['key'] = ['id' => $vlist['id'], 'name' => $vlist["name$lang"], 'slug' => $vlist["slug$lang"]];        $_menu[$klist]['cat'] = $d->rawQuery("select name$lang, slugvi, slugen, id from #_product_cat where id_list = ? and find_in_set('hienthi',status) order by numb,id desc", array($vlist['id']));        foreach ($_menu[$klist]['cat'] as $kcat => $vcat) {            $_menu[$klist]['cat'][$kcat]['key'] = ['id' => $vcat['id'], 'name' => $vcat["name$lang"], 'slug' => $vcat["slug$lang"]];            $_menu[$klist]['cat'][$kcat]['items'] = $d->rawQuery("select name$lang, slugvi, slugen, id from #_product_item where id_cat = ? and find_in_set('hienthi',status) order by numb,id desc", array($vcat['id']));        }    }    return $_menu;});$ttlist = $cache->get("select name$lang, slugvi, slugen, id from #_news_list where type = ? and find_in_set('hienthi',status) order by numb,id desc", array('dich-vu'), 'result', 7200);$footer = $cache->get("select name$lang, content$lang from #_static where type = ? limit 0,1", array('footer'), 'fetch', 7200);$ttlistChinhsach = $cache->get("select name$lang, slugvi, slugen, id from #_news where type = ? and find_in_set('hienthi',status) order by numb,id desc", array('chinh-sach'), 'result', 7200);$newsDichvu = $cache->get("select * from #_news where type = ? and find_in_set('hienthi',status) and find_in_set('noibat',status) order by numb,id desc limit 5", array('dich-vu'), 'result', 7200);$newsTinTuc = $cache->get("select * from #_news where type = ? and find_in_set('hienthi',status) order by numb,id desc limit 5", array('tin-tuc'), 'result', 7200);$newsDuan = $cache->get("select * from #_news where type = ? and find_in_set('hienthi',status) and find_in_set('noibat',status) order by numb,id desc limit 5", array('du-an'), 'result', 7200);if (isset($config['product']['san-pham']['tags'])) {    $tagsProduct = $cache->get("select name$lang, slugvi, slugen, id from #_tags where type = ? and find_in_set('noibat',status) and find_in_set('hienthi',status) order by numb,id desc", array('san-pham'), 'result', 7200);}if ($config['news']['tin-tuc']['tags']) {    $tagsNews = $cache->get("select name$lang, slugvi, slugen, id from #_tags where type = ? and find_in_set('noibat',status) and find_in_set('hienthi',status) order by numb,id desc", array('tin-tuc'), 'result', 7200);}$policy = $cache->get("select name$lang, slugvi, slugen, id, photo from #_news where type = ? and find_in_set('hienthi',status) order by numb,id desc", array('chinh-sach'), 'result', 7200);/* Get statistic */$counter = $statistic->getCounter();$online = $statistic->getOnline();/* Newsletter */if (!empty($_POST['submit-newsletter'])) {    $responseCaptcha = $_POST['recaptcha_response_newsletter'];    $resultCaptcha = $func->checkRecaptcha($responseCaptcha);    $scoreCaptcha = (!empty($resultCaptcha['score'])) ? $resultCaptcha['score'] : 0;    $actionCaptcha = (!empty($resultCaptcha['action'])) ? $resultCaptcha['action'] : '';    $testCaptcha = (!empty($resultCaptcha['test'])) ? $resultCaptcha['test'] : false;    $dataNewsletter = (!empty($_POST['dataNewsletter'])) ? $_POST['dataNewsletter'] : null;    /* Valid data */    if (empty($dataNewsletter['email'])) {        $flash->set('error', 'Email không được trống');    }    if (!empty($dataNewsletter['email']) && !$func->isEmail($dataNewsletter['email'])) {        $flash->set('error', 'Email không hợp lệ');    }    $error = $flash->get('error');    if (!empty($error)) {        $func->transfer($error, $configBase, false);    }    /* Save data */    if (($scoreCaptcha >= 0.5 && $actionCaptcha == 'Newsletter') || $testCaptcha == true) {        $data = array();        $data['email'] = htmlspecialchars($dataNewsletter['email']);        $data['date_created'] = time();        $data['type'] = 'dangkynhantin';        if ($d->insert('newsletter', $data)) {            $func->transfer("Đăng ký nhận tin thành công. Chúng tôi sẽ liên hệ với bạn sớm.", $configBase);        } else {            $func->transfer("Đăng ký nhận tin thất bại. Vui lòng thử lại sau.", $configBase, false);        }    } else {        $func->transfer("Đăng ký nhận tin thất bại. Vui lòng thử lại sau.", $configBase, false);    }}